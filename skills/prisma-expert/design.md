# prisma-expert: 設計ガイダンス

## スキーマ設計の判断基準

### 主キー戦略の選択

- 単一 DB の内部 ID: autoincrement Int/BigInt が基本。21億超の可能性があれば BigInt
- 外部公開 ID: CUID2 を推奨。UUID v4 より順序性とユニーク性のバランスが良い
- UUID v4 は大規模テーブルでインデックス断片化を起こすため、外部公開 ID には CUID を選択する

### データ型の選択指針

- 金額は必ず Decimal。Float の浮動小数点丸め誤差はビジネスロジックに致命的
- JSON 型は構造化データには使わない。専用モデルを優先し、型安全性を確保する
- DateTime は常に Timestamptz を検討する（タイムゾーン対応）
- String に VarChar(n) を付けるのは制約が必要な場合のみ

### リレーション設計のトレードオフ

- 多対多リレーション: 暗黙的（@relation のみ）は中間テーブルにフィールド追加不可。明示的中間テーブルを選択することで、作成日時やメタデータの追加が可能になる
- 自己参照リレーション: 階層構造には名前付きリレーションを使い、親子関係を明示する
- カスケード設定: デフォルトは Restrict（安全側）。Cascade は親削除で子も不要なケース（セッション等）のみ

### 命名規約の設計意図

- Prisma モデル名は PascalCase 単数形で TypeScript の型名と一致させる
- DB カラムは @@map/@map で snake_case にマッピング。ORM 層とDB層の命名規約を分離する
- Enum 値は UPPER_SNAKE_CASE で @map により snake_case 化。アプリ側の定数命名規約と一致

## クエリ最適化の設計指針

### N+1 問題への対処パターン選択

- include: リレーションを一括取得。最もシンプルだが 2 クエリ発行
- in フィルタ: 手動で ID 配列を構築し一括取得。柔軟だが冗長
- relationLoadStrategy: "join": 1 クエリで完結。パフォーマンス最優先の場合に選択
- 選択基準: データ量が少なく単純なケースは include、パフォーマンスクリティカルな場合は join

### ページネーション戦略

- OFFSET ベース: 実装が単純だが深いページで線形に遅くなる。管理画面等の限定用途向き
- カーソルベース: 常に O(1) で一定パフォーマンス。ユーザー向けリスト表示の標準パターン
- findMany には必ず take で上限を設定し、意図しない大量データ取得を防ぐ

### 一括操作の判断

- ループ内の個別 create は N+1 問題と同じ構造。createMany で一括作成する
- upsert は findFirst + create/update のレースコンディションを構造的に防ぐ

## トランザクション設計

### パターン選択基準

- 順次トランザクション（$transaction 配列）: 結果が互いに依存しない操作の一括実行。読み取り用途に適する
- インタラクティブトランザクション: 前の操作の結果を次で使う場合。書き込みの一貫性保証に適する
- トランザクションは短く保つ。外部 API 呼び出しはトランザクション外に配置
- maxWait と timeout を明示的に設定し、デッドロックによる無限待機を防ぐ
- デッドロック防止: 複数レコードロック時は常に同じ順序（ID 昇順等）でアクセス

## インデックス戦略の設計考慮

- 外部キーインデックスは必須。PostgreSQL は自動生成しないため、設計時に必ず含める
- 複合インデックスの順序: 等値条件を先、範囲条件を後にすることでインデックスの選択性を最大化
- ユニーク制約は upsert の where 句で使用可能。設計段階で複合ユニーク制約を検討する
- 部分インデックスは Prisma 非対応。必要な場合はカスタムマイグレーションで対応

## アンチパターンと回避策

- 全フィールド取得: select で必要なフィールドのみ取得し、不要データの転送・メモリ消費を削減
- $queryRaw の多用: 型安全性の喪失と SQL インジェクションリスク。Prisma Client API で表現する
- OFFSET ページネーション: 深いページで線形に遅くなる。カーソルベースに移行する
- トランザクション内の外部 API: ロック保持時間が長くなる。API 呼び出しはトランザクション外で実行

## コネクション管理

- 開発環境: PrismaClient シングルトンパターンでホットリロード時のコネクション枯渇を防止
- サーバーレス環境: connection_limit は低め（5-10）。サーバー環境では高め（10-20）
- pool_timeout を設定してコネクション取得のタイムアウトを明示
