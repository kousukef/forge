# database-migrations: 設計ガイダンス

## Expand-Contract パターンの設計指針

### 3フェーズ構成

すべての破壊的スキーマ変更は Expand-Contract パターンで実施する。

- Phase 1 EXPAND: 新カラム/テーブルを追加（nullable または default 付き）。アプリは新旧両方に書き込み
- Phase 2 MIGRATE: アプリは新カラムから読み取り、新旧両方に書き込み。データ整合性を検証
- Phase 3 CONTRACT: アプリは新カラムのみ使用。旧カラムを別マイグレーションで削除

### パターン適用の判断基準

- カラム削除: コードから参照を削除（Deploy 1）→ カラム削除マイグレーション（Deploy 2）
- カラム名変更: @map でアプリ側のみ変更（推奨）。DB 側も変更する場合は Expand-Contract
- 型変更: 新カラム追加 → データ変換 → 旧カラム削除。直接変更はデータ切り捨てリスク
- NOT NULL 制約追加: バックフィルしてから制約追加。直接追加はテーブルロック + 全行書き換え

## データ損失リスクの分類と対策

### 高リスク操作（必ず Expand-Contract）

- カラム削除、カラム名変更、カラム型変更、テーブル削除
- これらは全てデータ完全消失またはアクセス不能のリスクがある

### 中リスク操作（事前確認が必要）

- UNIQUE 制約追加: 事前に重複データを確認・解消してから適用
- 外部キー制約追加: 事前に参照整合性を確認
- デフォルト値変更: 既存レコードには影響しないが影響範囲を確認

### 安全な操作（直接実行可能）

- nullable カラムの追加
- デフォルト値付きカラムの追加（PostgreSQL 11+ は即座に完了）
- テーブルの新規作成

## 段階的マイグレーション戦略

### DDL と DML の分離設計

スキーマ変更とデータ変更を別マイグレーションにする理由:
- ロールバックが容易になる（DDL のみロールバック可能）
- 長時間トランザクションを回避できる（大量 UPDATE をバッチ化可能）
- 各ステップを個別にテストできる

### 大量データバックフィルの設計

- バッチサイズ: 5000件程度を推奨。一括 UPDATE はテーブルロックを引き起こす
- 進捗ログ: バッチごとに処理件数を記録し、障害時の再開ポイントを特定可能にする
- 冪等性: 再実行しても安全な設計にする（WHERE 条件で未処理のみを対象）

## ロールバック戦略の設計

### ロールバック判断基準

- マイグレーション途中で失敗: `migrate resolve --rolled-back` + 手動修復
- マイグレーション成功、アプリにバグ: アプリをロールバック（スキーマはそのまま）
- データ破損の可能性: バックアップからリストア + `migrate resolve`

### down.sql の設計

- マイグレーション作成時に `prisma migrate diff` でロールバック SQL を生成しておく
- Prisma Migrate は forward のみのため、ロールバックは常に「新しいマイグレーション」として設計

## インデックス作成の設計考慮

### CONCURRENTLY 使用の判断基準

- テーブル行数が多い場合（目安: 10万行以上）は CONCURRENTLY を使用
- 通常の CREATE INDEX はテーブルへの書き込みをブロックする
- CONCURRENTLY はトランザクション内で実行不可のため、手動マイグレーションが必要

### インデックス種別の選択

- 等価検索: B-tree（@@index）
- 複合条件: 等価カラムを先、範囲カラムを後に配置した複合 B-tree
- UNIQUE 制約: @@unique で一意性を保証
- 部分インデックス: Prisma 非対応のためカスタム SQL マイグレーション

## @map によるカラム名変更の設計トレードオフ

- パターン 1（アプリ側のみ変更、@map 活用）: マイグレーション不要。データ損失リスクゼロ。推奨
- パターン 2（DB 側も変更）: Expand-Contract が必要。リスクが高い。DB 側の名前に強い理由がある場合のみ

## Prisma Migrate ワークフローの環境別設計

- 開発: `prisma migrate dev` で対話的にマイグレーション作成 + 適用
- カスタム SQL: `--create-only` で SQL を生成し手動編集してから適用
- 本番: `prisma migrate deploy` のみ。非対話的、アドバイザリーロック付き
- CI/CD: prisma/migrations/ の変更トリガーで `migrate deploy` を自動実行
