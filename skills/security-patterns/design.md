# security-patterns: 設計ガイダンス

## セキュリティ原則と設計への影響

### Defence in Depth（多層防御）

- 入力バリデーション + 出力エスケープ + CSP ヘッダーのように複数レイヤーで防御
- 1つの防御が破られても他のレイヤーが機能する設計にする
- セキュリティは「追加するもの」ではなく「デフォルトで有効なもの」

### Fail Secure

- エラー時はアクセス拒否方向に倒す
- 不明な状態では許可ではなく拒否をデフォルトにする
- セキュリティ防御策に YAGNI を適用しない。防御は常に先手で実装

## XSS 防止の設計

### 防御レイヤー

- 第1層: React のデフォルトエスケープ。JSX 内の変数はデフォルトでエスケープされる
- 第2層: dangerouslySetInnerHTML の禁止。やむを得ない場合は DOMPurify でサニタイズ
- 第3層: CSP ヘッダーでスクリプト実行を制限

### CSP ヘッダー設計

- default-src 'self' を基本とし、必要なソースのみ追加
- script-src は nonce ベースで制御
- frame-ancestors 'none' でクリックジャッキング防止
- form-action 'self' でフォーム送信先を制限

## CSRF 防止の設計パターン

### Server Actions（自動保護）

- Next.js Server Actions は CSRF 保護が組み込み済み。追加対策不要
- フォーム送信には Server Actions を優先することで CSRF 対策が自動化される

### Route Handlers（明示的対策）

- Origin ヘッダーの検証: 許可されたオリジンリストと照合
- Cookie の SameSite 属性: strict または lax を設定
- Server Actions で代替可能な場合は Server Actions を選択する（CSRF 対策の自動化）

## 入力バリデーションの設計指針

### ホワイトリスト方式の原則

- 許可する値を列挙する。ブラックリスト（禁止する値を列挙）は使わない
- Zod スキーマで型と一体化し、バリデーションと TypeScript 型の乖離を防ぐ
- Server Actions / Route Handlers は例外なく全入力を Zod で検証

### バリデーションの配置

- クライアント側: UX のため（即座のフィードバック）。セキュリティ目的では使わない
- サーバー側: セキュリティのため。全入力を必ず検証する
- 二重バリデーション: クライアントとサーバーの両方で行う

## 認証・認可の設計パターン

### 認証の多層防御

- 第1層: Middleware でルートレベル保護。保護対象パスへのアクセスを一括制御
- 第2層: Server Actions / Route Handlers 内での認証チェック。個別エンドポイントで確認

### 認可の設計

- ロールベースアクセス制御 + リソース所有権の二重チェック
- 認可チェックは必ずリソースアクセスの前に実行
- トークン保存先は httpOnly Cookie のみ。localStorage / sessionStorage はXSSで窃取可能

## ファイルアップロードの設計

- サイズ制限: 用途に応じた上限を設定（DoS 防止）
- MIME タイプ検証: ホワイトリスト方式で許可するタイプを限定
- ファイル名サニタイズ: パストラバーサル防止
- 保存先: Cloud Storage を使用。パブリックディレクトリ直接保存は禁止
- 本番環境ではマジックバイト検証を検討

## CORS 設計

- Access-Control-Allow-Origin: * は認証付き API で絶対不可
- オリジンのホワイトリスト: 環境変数で管理し動的検証
- Credentials 使用時: ワイルドカードオリジン不可
- Vary: Origin ヘッダーでキャッシュの正確性を保証

## シークレット管理の設計

### 環境別管理

- 開発環境: .env.local + Zod で起動時バリデーション
- 本番環境: GCP Secret Manager でシークレットを管理
- NEXT_PUBLIC_ プレフィックスにシークレットを含めない（クライアントに公開される）

### 情報漏洩防止

- エラーレスポンスに内部情報（スタックトレース、DB 詳細）を含めない
- シークレットを console.log / エラーメッセージに含めない
- NODE_ENV === 'production' ではデバッグ情報を一切出力しない

## SQL インジェクション防止

- Prisma Client のパラメータ化クエリのみ使用
- $queryRaw テンプレートリテラルは自動パラメータ化で安全
- $queryRawUnsafe は使用禁止。動的カラム名はホワイトリストで検証

## レート制限の設計

- API エンドポイントにはレート制限を設ける
- 認証エンドポイントには特に厳しい制限
- 本番は Redis ベース（サーバーレスではインメモリは共有不可）
